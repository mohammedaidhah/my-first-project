<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام سجل الزوار - GoStation</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #3D2F7B;
            --accent: #EC671F;
            --bg-light: #f3f4f7;
            --text-dark: #2c3e50;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-light);
            overflow-x: hidden;
        }

        .sidebar {
            min-height: 100vh;
            background: var(--primary);
            color: white;
            padding-top: 20px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            position: fixed;
            right: 0;
            width: 260px;
            z-index: 1000;
            transition: all 0.3s;
        }

        .logo-area {
            text-align: center;
            padding: 0 20px 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .logo-area img {
            max-width: 140px;
            height: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .nav-link {
            color: rgba(255,255,255,0.85);
            padding: 15px 25px;
            margin: 5px 15px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .nav-link i { margin-left: 12px; width: 20px; text-align: center; font-size: 1.1rem; }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(-5px);
        }

        .nav-link.active {
            background: linear-gradient(45deg, var(--accent), #ff8e4b);
            color: white;
            box-shadow: 0 4px 15px rgba(236, 103, 31, 0.4);
        }

        .auto-save-box {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            padding: 15px;
        }
        .save-badge {
            background: rgba(0,0,0,0.3);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #bdc3c7;
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .pulse { animation: pulse-anim 2s infinite; color: #2ecc71; }
        @keyframes pulse-anim { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .main-content {
            margin-right: 260px;
            padding: 30px;
            transition: all 0.3s;
        }

        .header-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-card {
            border: none;
            border-radius: 16px;
            color: white;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stat-card:hover { transform: translateY(-5px); }
        
        .card-bg-1 { background: linear-gradient(135deg, var(--primary), #5a4b9f); }
        .card-bg-2 { background: linear-gradient(135deg, var(--accent), #f39c12); }
        .card-bg-3 { background: linear-gradient(135deg, #2c3e50, #4ca1af); }

        .stat-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3.5rem;
            opacity: 0.2;
        }

        .stat-value { font-size: 2.5rem; font-weight: 700; margin: 0; }
        .stat-label { font-size: 1rem; opacity: 0.9; }

        .content-card {
            background: white;
            border-radius: 16px;
            border: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 25px;
        }

        .form-control, .form-select {
            border-radius: 10px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            background-color: #f9f9f9;
        }
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(61, 47, 123, 0.1);
            background-color: white;
        }
        
        .btn-brand {
            background-color: var(--primary);
            color: white;
            border-radius: 10px;
            padding: 10px 30px;
            font-weight: 600;
            border: none;
        }
        .btn-brand:hover { background-color: #2b205a; color: white; }

        .btn-accent {
            background-color: var(--accent);
            color: white;
            border-radius: 10px;
            padding: 10px 30px;
            font-weight: 600;
            border: none;
        }
        .btn-accent:hover { background-color: #d35400; color: white; }

        .table thead th {
            background-color: #f8f9fa;
            color: var(--primary);
            font-weight: 700;
            border-bottom: 2px solid #eee;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .sidebar { width: 80px; padding-top: 15px; }
            .sidebar .logo-area img { max-width: 40px; }
            .nav-link span { display: none; }
            .nav-link i { margin: 0; font-size: 1.5rem; }
            .main-content { margin-right: 80px; padding: 15px; }
            .auto-save-box { display: none; }
            .chart-wrapper { height: 250px; }
        }
    </style>
</head>
<body>
<div style="position: fixed; top: 15px; right: 25px; z-index: 9999;">
    <img src="logo gostation.png" alt="شعار قوستيشن" style="height: 55px;">
</div>

<div class="sidebar">
    <div class="logo-area">
        <img src="logo.png" alt="GoStation Logo"
             onerror="this.style.display='none'; document.getElementById('alt-logo').style.display='block';">
        <h4 id="alt-logo" style="display:none; color:white; font-weight:bold; margin-top:10px;">Go Station</h4>
    </div>
    
    <nav class="nav flex-column">
        <a class="nav-link active" onclick="switchPage('register')">
            <i class="fas fa-plus-circle"></i> <span>تسجيل زائر</span>
        </a>
        <a class="nav-link" onclick="switchPage('dashboard')">
            <i class="fas fa-chart-pie"></i> <span>لوحة القيادة</span>
        </a>
        <a class="nav-link" onclick="switchPage('settings')">
            <i class="fas fa-cogs"></i> <span>إدارة النظام</span>
        </a>
    </nav>

    <div class="auto-save-box">
        <div class="save-badge">
            <i class="fas fa-circle pulse" id="saveDot"></i> 
            <span id="saveStatus">النظام متصل</span>
        </div>
    </div>
</div>

<div class="main-content">
    
    <div id="register-page" class="fade-in">
        <div class="header-title">
            <h3><i class="fas fa-door-open ms-2 text-warning"></i> بوابة الزوار</h3>
            <div class="text-muted h6">
                <i class="far fa-clock ms-1"></i> <span id="headerTime">--:--</span>
            </div>
        </div>

        <!-- النموذج الموحد -->
        <form id="visitor-form">
            <div class="content-card">
                <h5 class="mb-4 text-primary fw-bold">بيانات الدخول</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted small">تاريخ اليوم</label>
                        <input type="text" class="form-control" id="autoDate" name="date" readonly
                               style="background:#f1f2f6; cursor:not-allowed;">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">وقت الوصول</label>
                        <input type="text" class="form-control" id="autoTime" name="timeIn" readonly
                               style="background:#f1f2f6; cursor:not-allowed;">
                    </div>

                    <div class="col-12"><hr class="text-muted opacity-25"></div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">اسم الزائر <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="vName" name="name"
                               placeholder="الاسم الثلاثي" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">رقم الجوال <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="vMobile" name="mobile"
                               placeholder="05xxxxxxxx" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">الجهة / الشركة</label>
                        <input type="text" class="form-control" id="vOrg" name="org"
                               placeholder="اسم الجهة القادم منها" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">الإدارة المستهدفة</label>
                        <select class="form-select" id="vDept" name="dept" required></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">الغرض من الزيارة</label>
                        <select class="form-select" id="vReason" name="reason">
                            <option value="اجتماع عمل">اجتماع عمل</option>
                            <option value="مقابلة توظيف">مقابلة توظيف</option>
                            <option value="خدمات صيانة">خدمات صيانة</option>
                            <option value="توصيل بريد/طرد">توصيل بريد/طرد</option>
                            <option value="زيارة رسمية">زيارة رسمية</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">موعد مسبق؟</label>
                        <select class="form-select" id="vAppt" name="appt">
                            <option value="نعم">نعم</option>
                            <option value="لا">لا</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label">ملاحظات إضافية</label>
                        <textarea class="form-control" id="vNotes" name="notes" rows="2"></textarea>
                    </div>

                    <div class="col-12 mt-4 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary px-4"
                                onclick="document.getElementById('visitor-form').reset()">
                            <i class="fas fa-undo ms-2"></i> مسح
                        </button>
                        <button type="button" class="btn btn-brand px-4" onclick="printBadge()">
                            <i class="fas fa-id-badge ms-2"></i> طباعة تصريح
                        </button>
                        <button type="submit" class="btn btn-accent px-5">
                            <i class="fas fa-save ms-2"></i> حفظ الدخول
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- باقي الصفحات بدون تغيير جوهري -->
    <div id="dashboard-page" style="display: none;">
        <!-- ... كما هو في كودك السابق ... -->
    </div>

    <div id="settings-page" style="display: none;">
        <!-- ... كما هو في كودك السابق ... -->
    </div>
</div>

<script>
    // === المتغيرات والإعدادات ===
    let visitorsDB = [];
    const departments = [
        "رئيس مجلس الادارة", "مكتب الرئيس التنفيذي", "الرئيس التنفيذي للتطوير ونائب الرئيس التنفيذي",
        "الرئيس التنفيذي للعمليات", "الرئيس التنفيذي المالي", "التشغيل", "الصيانة", "التسويق",
        "تقنية المعلومات", "الجودة", "المشتريات", "المشاريع", "الممتلكات", "علاقات حكومية",
        "موارد بشرية", "النقليات", "الامتياز التجاري", "الشؤون القانونية", "الادارة المالية"
    ];

    document.addEventListener('DOMContentLoaded', () => {
        const deptSelect = document.getElementById('vDept');
        departments.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.innerText = d;
            deptSelect.appendChild(opt);
        });

        updateDateTime();
        setInterval(updateDateTime, 1000);
        loadDataFromLocal();
        setInterval(autoSaveProcess, 10000);
        updateDashboard();
    });

    function updateDateTime() {
        const now = new Date();
        document.getElementById('autoDate').value = now.toLocaleDateString('en-GB');
        document.getElementById('autoTime').value = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('headerTime').innerText =
            now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
    }

    function switchPage(pageId) {
        document.getElementById('register-page').style.display = 'none';
        document.getElementById('dashboard-page').style.display = 'none';
        document.getElementById('settings-page').style.display = 'none';
        document.getElementById(pageId + '-page').style.display = 'block';
        
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const links = document.querySelectorAll('.nav-link');
        if(pageId === 'register') links[0].classList.add('active');
        if(pageId === 'dashboard') { links[1].classList.add('active'); updateDashboard(); }
        if(pageId === 'settings') links[2].classList.add('active');
    }

    // الحفظ المحلي للداشبورد (كما هو)
    function loadDataFromLocal() {
        const data = localStorage.getItem('GoStationDB');
        if(data) visitorsDB = JSON.parse(data);
    }

    function saveDataToLocal() {
        localStorage.setItem('GoStationDB', JSON.stringify(visitorsDB));
    }

    function autoSaveProcess() {
        saveDataToLocal();
        const badge = document.getElementById('saveStatus');
        const dot = document.getElementById('saveDot');
        badge.innerText = 'تم الحفظ: ' +
            new Date().toLocaleTimeString('en-US',
                {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
        dot.style.color = '#2ecc71';
        setTimeout(() => { badge.innerText = 'النظام متصل'; }, 3000);
    }

    // === الداشبورد والرسوم كما هي (اختصرتها هنا للحجم) ===
    // احتفظ بجميع دوال updateDashboard / renderTable / deleteVisitor / drawCharts / printBadge / exportToExcel / downloadBackup / restoreBackup / clearAllData كما في كودك الأصلي.

</script>
function updateDashboard() {
  // إجمالي الزوار
  document.getElementById('statTotal').innerText = visitorsDB.length.toLocaleString();

  // زوار اليوم
  const todayStr = new Date().toLocaleDateString('en-GB');
  const todayCount = visitorsDB.filter(v => v.date === todayStr).length;
  document.getElementById('statToday').innerText = todayCount;

  // أكثر إدارة استقبالاً للزوار
  const deptCounts = {};
  visitorsDB.forEach(v => {
    if (!v.dept) return;
    deptCounts[v.dept] = (deptCounts[v.dept] || 0) + 1;
  });

  let topDept = '-';
  let maxVal = 0;
  for (const [d, c] of Object.entries(deptCounts)) {
    if (c > maxVal) {
      maxVal = c;
      topDept = d;
    }
  }
  document.getElementById('statTopDept').innerText = topDept;

  // تحديث الجدول والرسوم
  renderTable();
  drawCharts(deptCounts);
}

<!-- سكربت ربط النموذج بـ /api/visitors -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("visitor-form");

    if (!form) {
      console.error("لم يتم العثور على النموذج visitor-form");
      return;
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const data = {
        date:   formData.get("date"),
        timeIn: formData.get("timeIn"),
        name:   formData.get("name"),
        mobile: formData.get("mobile"),
        org:    formData.get("org"),
        dept:   formData.get("dept"),
        reason: formData.get("reason"),
        appt:   formData.get("appt"),
        notes:  formData.get("notes"),
      };

      // تحديث الداشبورد والـ localStorage محليًا
      visitorsDB.push({
        id: Date.now(),
        ...data
      });
      if (typeof saveDataToLocal === "function") {
        saveDataToLocal();
      }
      if (typeof updateDashboard === "function") {
        updateDashboard();
      }

      try {
        const res = await fetch("/api/visitors", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await res.json();

        if (res.ok) {
          Swal.fire("تم الحفظ", "تم حفظ الزائر في النظام", "success");
          form.reset();
        } else {
          Swal.fire("خطأ", result.message || "حدث خطأ أثناء الحفظ", "error");
        }
      } catch (err) {
        console.error(err);
        Swal.fire("خطأ اتصال", "تعذر الاتصال بالخادم، حاول مرة أخرى", "error");
      }
    });
  });
</script>


</body>
</html>


