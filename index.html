<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø± - GoStation</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Ù†ÙØ³ Ø§Ù„Ù€ CSS Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ -->
  <style>
    :root {
      --primary: #3D2F7B;
      --accent: #EC671F;
      --bg-light: #f3f4f7;
      --text-dark: #2c3e50;
    }
    /* ... Ù†ÙØ³ Ø§Ù„Ù€ CSS styles Ù…Ù† paste.txt ... */
    /* Ø§Ù†Ø³Ø® ÙƒØ§Ù…Ù„ Ø§Ù„Ù€ style Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ */
  </style>
</head>
<body>
  <!-- Ù†ÙØ³ Ø§Ù„Ù€ HTML structure Ù…Ù† paste.txt -->
  <!-- Ø§Ù†Ø³Ø® ÙƒØ§Ù…Ù„ Ø§Ù„Ù€ HTML Ù…Ù† paste.txt Ù‡Ù†Ø§ -->
  
  <script>
    // ğŸ”¥ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙØµØ­Ø­ Ø§Ù„ÙƒØ§Ù…Ù„
    let visitorsDB = [];
    const departments = [
      "Ø±Ø¦ÙŠØ³ Ù…Ø¬Ù„Ø³ Ø§Ù„Ø§Ø¯Ø§Ø±Ø©", "Ù…ÙƒØªØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ", "Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù„ØªØ·ÙˆÙŠØ± ÙˆÙ†Ø§Ø¦Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ",
      "Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ø§Ù„Ù…Ø§Ù„ÙŠ", "Ø§Ù„ØªØ´ØºÙŠÙ„", "Ø§Ù„ØµÙŠØ§Ù†Ø©", "Ø§Ù„ØªØ³ÙˆÙŠÙ‚",
      "ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", "Ø§Ù„Ø¬ÙˆØ¯Ø©", "Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", "Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹", "Ø§Ù„Ù…Ù…ØªÙ„ÙƒØ§Øª", "Ø¹Ù„Ø§Ù‚Ø§Øª Ø­ÙƒÙˆÙ…ÙŠØ©",
      "Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø´Ø±ÙŠØ©", "Ø§Ù„Ù†Ù‚Ù„ÙŠØ§Øª", "Ø§Ù„Ø§Ù…ØªÙŠØ§Ø² Ø§Ù„ØªØ¬Ø§Ø±ÙŠ", "Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©", "Ø§Ù„Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©"
    ];

    const PASSWORD_CONFIG = {
      register: 'gostation123',
      settings: 'admin2025'
    };

    let accessStatus = { register: false, settings: false };
    let currentRequiredPage = '';
    let db;
    let chartDeptInstance = null;
    let chartTimeInstance = null;

    // ğŸ”¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø­Ø³Ù†
    const syncChannel = new BroadcastChannel('gostation-sync');
    syncChannel.onmessage = (event) => {
      if (event.data.type === 'restore') {
        visitorsDB = event.data.data;
        saveAllData();
        updateDashboard();
        if (accessStatus.register) renderTable();
        showSyncStatus('ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± âœ…');
      } else if (event.data.type === 'newVisitor') {
        if (!visitorsDB.some(v => v._id === event.data.data._id)) {
          visitorsDB.unshift(event.data.data);
          saveAllData();
          updateDashboard();
          if (accessStatus.register) renderTable();
        }
      }
    };

    // ğŸ”¥ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
    document.addEventListener('DOMContentLoaded', () => {
      const deptSelect = document.getElementById('vDept');
      departments.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.innerText = d;
        deptSelect.appendChild(opt);
      });

      updateDateTime();
      setInterval(updateDateTime, 1000);
      initIndexedDB();
      loadData();
      setInterval(autoSaveProcess, 10000);
      checkSavedAccess();
      setupVisitorForm(); // ğŸ”¥ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    });

    // ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙØµØ­Ø­Ø© (Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¶Ù…ÙˆÙ†)
    function setupVisitorForm() {
      const form = document.getElementById('visitor-form');
      if (!form) return;

      form.addEventListener('submit', async function(e) {
        if (!accessStatus.register) {
          Swal.fire('ğŸš« ØºÙŠØ± Ù…ØµØ±Ø­', 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±: gostation123', 'warning');
          return;
        }

        e.preventDefault();

        // ğŸ”¥ ØªÙˆÙ„ÙŠØ¯ ID ÙØ±ÙŠØ¯ Ù…Ø¶Ù…ÙˆÙ†
        const formData = new FormData(form);
        const visitorData = {
          _id: crypto.randomUUID(), // ID ÙØ±ÙŠØ¯ 100%
          date: formData.get('date'),
          timeIn: formData.get('timeIn'),
          name: formData.get('name'),
          mobile: formData.get('mobile'),
          org: formData.get('org'),
          dept: formData.get('dept'),
          reason: formData.get('reason'),
          appt: formData.get('appt'),
          notes: formData.get('notes'),
          createdAt: new Date().toISOString()
        };

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø®Ø§Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        try {
          const res = await fetch('/api/visitors', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(visitorData)
          });
          if (res.ok) {
            console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…');
          }
        } catch (err) {
          console.log('â„¹ï¸ Ø§Ù„Ø®Ø§Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙƒØ§ÙÙŠ');
        }

        // ğŸ”¥ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„ÙÙˆØ±ÙŠ (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)
        visitorsDB.unshift(visitorData);
        saveAllData();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        form.reset();
        updateDashboard();
        if (accessStatus.register) renderTable();

        // ğŸ”¥ Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        syncChannel.postMessage({ 
          type: 'newVisitor', 
          data: visitorData 
        });

        Swal.fire({
          title: 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø²Ø§Ø¦Ø±!',
          html: `
            <div class="text-success">
              <i class="fas fa-check-circle fa-2x mb-2 d-block"></i>
              <strong>${visitorData.name}</strong><br>
              <small>ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ + Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ©</small>
            </div>
          `,
          icon: 'success',
          timer: 2500,
          showConfirmButton: false
        });
      });
    }

    // ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø´Ø§Ù…Ù„Ø©
    function saveAllData() {
      saveDataToLocal();
      if (db) saveDataToIndexedDB(visitorsDB);
    }

    // ğŸ”¥ IndexedDB Ù…ÙØ­Ø³Ù† (version 2)
    function initIndexedDB() {
      const request = indexedDB.open('GoStationDB', 2);
      
      request.onerror = () => {
        console.error('âŒ IndexedDB error - LocalStorage only');
      };
      
      request.onsuccess = (event) => {
        db = event.target.result;
        loadDataFromIndexedDB();
      };
      
      request.onupgradeneeded = (event) => {
        db = event.target.result;
        const store = db.createObjectStore('visitors', { keyPath: '_id' });
        console.log('âœ… IndexedDB initialized v2');
      };
    }

    function saveDataToIndexedDB(data) {
      if (!db) return;
      const tx = db.transaction(['visitors'], 'readwrite');
      const store = tx.objectStore('visitors');
      store.clear().onsuccess = () => {
        data.forEach(visitor => store.add(visitor));
      };
    }

    function loadDataFromIndexedDB() {
      if (!db) return;
      const tx = db.transaction(['visitors'], 'readonly');
      const store = tx.objectStore('visitors');
      const request = store.getAll();
      
      request.onsuccess = () => {
        if (request.result.length > 0) {
          visitorsDB = request.result;
          saveDataToLocal();
          updateDashboard();
          if (accessStatus.register) renderTable();
        } else {
          loadDataFromLocal();
        }
      };
    }

    function saveDataToLocal() {
      localStorage.setItem('GoStationDB', JSON.stringify(visitorsDB));
    }

    function loadDataFromLocal() {
      try {
        const data = localStorage.getItem('GoStationDB');
        if (data) {
          visitorsDB = JSON.parse(data);
          updateDashboard();
          if (accessStatus.register) renderTable();
        }
      } catch (e) {
        console.error('LocalStorage corrupted, starting fresh');
      }
    }

    // ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø®Ø§Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù…Ø­Ù„ÙŠ fallback)
    async function loadData() {
      showSyncStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
      
      try {
        const res = await fetch('/api/visitors', {
          method: 'GET',
          headers: { 'Cache-Control': 'no-cache' }
        });
        if (res.ok) {
          visitorsDB = await res.json();
          saveAllData();
          showSyncStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
          return;
        }
      } catch (err) {
        console.log('â„¹ï¸ Server unavailable');
      }
      
      loadDataFromIndexedDB();
      showSyncStatus('ğŸ’¾ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
    }

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (Ø§Ù†Ø³Ø®Ù‡Ø§ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ paste.txt)
    function showSyncStatus(message, isError = false) {
      const statusEl = document.getElementById('syncStatus');
      const messageEl = document.getElementById('syncMessage');
      if (!statusEl || !messageEl) return;
      
      messageEl.textContent = message;
      statusEl.className = `sync-status ${isError ? 'error' : ''}`;
      statusEl.style.display = 'block';
      setTimeout(() => statusEl.style.display = 'none', 4000);
    }

    function checkSavedAccess() {
      const savedRegister = localStorage.getItem('registerAccess');
      const savedSettings = localStorage.getItem('settingsAccess');
      if (savedRegister === 'true') {
        accessStatus.register = true;
        unlockPage('register');
      }
      if (savedSettings === 'true') {
        accessStatus.settings = true;
        unlockPage('settings');
      }
    }

    function saveAccess(page) {
      localStorage.setItem(page + 'Access', 'true');
      accessStatus[page] = true;
      unlockPage(page);
    }

    function unlockPage(page) {
      const link = document.getElementById(page + 'Link');
      if (link) link.classList.remove('locked');
    }

    function checkPassword(page) {
      if (accessStatus[page]) {
        switchPage(page);
      } else {
        currentRequiredPage = page;
        showPasswordModal(page);
      }
    }

    function showPasswordModal(page) {
      document.getElementById('passwordModal').style.display = 'flex';
      document.getElementById('passwordInput').focus();
      document.getElementById('passwordHint').textContent = 
        `${page === 'register' ? 'Ø³Ø¬Ù„ Ø§Ù„Ø²ÙˆØ§Ø±' : 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…'}`;
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('passwordInput').value = '';
    }

    function verifyPassword() {
      const password = document.getElementById('passwordInput').value;
      const requiredPassword = PASSWORD_CONFIG[currentRequiredPage];
      
      if (password === requiredPassword) {
        saveAccess(currentRequiredPage);
        closePasswordModal();
        switchPage(currentRequiredPage);
        Swal.fire({
          title: 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚!',
          text: 'ØªÙ… Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©',
          icon: 'success',
          timer: 1500,
          showConfirmButton: false
        });
      } else {
        Swal.fire({
          title: 'âŒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!',
          text: 'Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰',
          icon: 'error',
          timer: 2000,
          showConfirmButton: false
        });
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
      }
    }

    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && document.getElementById('passwordModal').style.display === 'flex') {
        verifyPassword();
      }
    });

    function updateDateTime() {
      const now = new Date();
      const dateInput = document.getElementById('autoDate');
      const timeInput = document.getElementById('autoTime');
      const headerTime = document.getElementById('headerTime');
      
      if (dateInput) dateInput.value = now.toLocaleDateString('en-GB');
      if (timeInput) timeInput.value = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
      if (headerTime) headerTime.innerText = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
    }

    function switchPage(pageId) {
      ['register-page', 'dashboard-page', 'settings-page'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      document.getElementById(pageId + '-page').style.display = 'block';

      const links = document.querySelectorAll('.nav-link');
      links.forEach(l => l.classList.remove('active'));
      
      const activeIndex = { dashboard: 0, register: 1, settings: 2 }[pageId];
      if (activeIndex !== undefined) links[activeIndex].classList.add('active');

      if (pageId === 'dashboard') updateDashboard();
      if (pageId === 'register' && accessStatus.register) renderTable();
    }

    function autoSaveProcess() {
      saveAllData();
      const badge = document.getElementById('saveStatus');
      const dot = document.getElementById('saveDot');
      if (badge && dot) {
        const time = new Date().toLocaleTimeString('en-US', {
          hour12: false, hour: '2-digit', minute: '2-digit'
        });
        badge.innerText = `ØªÙ… Ø§Ù„Ø­ÙØ¸: ${time}`;
        dot.style.color = '#2ecc71';
        setTimeout(() => { 
          badge.innerText = 'Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªØµÙ„ âœ…'; 
        }, 3000);
      }
    }

    function updateDashboard() {
      document.getElementById('statTotal').innerText = visitorsDB.length.toLocaleString();
      
      const todayStr = new Date().toLocaleDateString('en-GB');
      const todayCount = visitorsDB.filter(v => v.date === todayStr).length;
      document.getElementById('statToday').innerText = todayCount;

      const deptCounts = {};
      visitorsDB.forEach(v => {
        if (v.dept) deptCounts[v.dept] = (deptCounts[v.dept] || 0) + 1;
      });

      let topDept = '-', maxVal = 0;
      for (const [d, c] of Object.entries(deptCounts)) {
        if (c > maxVal) {
          maxVal = c;
          topDept = d;
        }
      }
      document.getElementById('statTopDept').innerText = topDept;
      
      drawCharts(deptCounts);
    }

    function renderTable() {
      if (!accessStatus.register) return;
      const tbody = document.getElementById('tableBody');
      const filterInput = document.getElementById('searchBox');
      const filter = filterInput ? filterInput.value.toUpperCase() : '';
      tbody.innerHTML = '';

      [...visitorsDB].reverse().forEach(v => {
        if (!filter || 
            (v.name && v.name.toUpperCase().includes(filter)) || 
            (v.org && v.org.toUpperCase().includes(filter))) {
          
          const row = `
            <tr>
              <td>${v.date || ''}</td>
              <td>${v.timeIn || ''}</td>
              <td class="fw-bold text-primary">${v.name || ''}</td>
              <td>${v.org || ''}</td>
              <td><span class="badge bg-light text-dark border">${v.dept || ''}</span></td>
              <td><span class="badge bg-success">ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„</span></td>
              <td>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteVisitor('${v._id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>`;
          tbody.insertAdjacentHTML('beforeend', row);
        }
      });
    }

    async function deleteVisitor(id) {
      if (!accessStatus.register) return;
      
      Swal.fire({
        title: 'Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ',
        text: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33'
      }).then(async result => {
        if (result.isConfirmed) {
          try {
            await fetch(`/api/visitors/${id}`, { method: 'DELETE' });
          } catch (err) {
            console.log('Server delete failed, local only');
          }
          
          visitorsDB = visitorsDB.filter(v => v._id !== id);
          saveAllData();
          updateDashboard();
          renderTable();
          Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…', '', 'success');
        }
      });
    }

    function drawCharts(deptCounts) {
      // Charts code from original (copy from paste.txt)
      // ... Ø±Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    }

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„: printBadge, exportToExcel, downloadBackup, etc.
    // Ø§Ù†Ø³Ø®Ù‡Ø§ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ paste.txt Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±
  </script>
</body>
</html>
